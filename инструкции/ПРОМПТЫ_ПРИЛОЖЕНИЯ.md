# ПРОМПТЫ ПРИЛОЖЕНИЯ normativ_docs

**Дата создания:** 2026-01-09
**Приложение:** normativ_docs (поиск по нормативным документам ЖКХ)
**Файл с промптами:** `/home/olga/normativ_docs/Волков/vector-db-test/backend/main_cpu.py`

---

## Обзор

Приложение использует YandexGPT для:
1. **Переформулирования запросов** в термины нормативных документов
2. **Валидации результатов** поиска (проверка наличия конкретного ответа)
3. **Реранжирования результатов** (выбор лучшего фрагмента)
4. **Упрощения текста** нормативных документов на простой язык

---

## ПРОМПТ #1: Переформулирование запроса

**Функция:** `reformulate_query(original_query: str)`
**Строка:** 103 (обновлено 2026-01-09)
**Назначение:** Преобразование разговорного запроса пользователя в термины нормативных документов ЖКХ

### Полный промпт:

```python
prompt = f"""Ты - эксперт по нормативным документам ЖКХ РФ.
Переформулируй вопрос пользователя в терминах нормативных документов.

ПРАВИЛА:
1. Используй ТОЛЬКО официальную терминологию из ЖК РФ, Правил 354, Правил 491
2. ВСЕГДА приводи разговорные фразы к юридическим терминам:
   - "сменить УК" → "расторжение договора управления многоквартирным домом"
   - "как сменить управляющую компанию" → "расторжение или изменение договора управления"
   - "кто платит" → "обязанность по внесению платы, размер платы"
   - "начисления" → "расчет размера платы"
   - "платить за свет" → "коммунальная услуга по электроснабжению"
   - "мкд" → "многоквартирный дом"
   - "батареи" → "отопление"
   - "протокол собрания" → "протокол общего собрания собственников"
   - "заполняется" → "порядок оформления"
   - "что такое" → "определение, понятие"
   - "что входит" → "состав, перечень, включает в себя"
3. Сохраняй смысл вопроса
4. Используй формулировки из статей и нормативных актов
5. Добавляй синонимы и связанные понятия для улучшения поиска:
   - "общее имущество" → добавляй "помещения общего пользования, конструктивные элементы, несущие конструкции"
   - "права собственника" → добавляй "права собственности, владение, пользование, распоряжение"
   - "коммунальные платежи" → добавляй "размер платы, тарифы, нормативы, расчет"
   - "входит в состав" → добавляй "состав, перечень, включает в себя"
6. КРИТИЧЕСКИ ВАЖНО - Приоритет упомянутых документов:
   ЕСЛИ в запросе УПОМИНАЕТСЯ конкретный документ (Правила 354, ЖК РФ, ПП 491, Правила 306, ГК РФ и т.д.):
   - ДОБАВЬ в начало запроса: "найди в [полное название документа]"
   - Используй ПОЛНОЕ официальное название документа из этого списка:
     * "Правила 354" → "найди в Постановлении Правительства РФ от 06.05.2011 № 354 Правила предоставления коммунальных услуг"
     * "Правила 306" → "найди в Постановлении Правительства РФ от 23.05.2006 № 306 Правила установления нормативов потребления"
     * "Правила 491" → "найди в Постановлении Правительства РФ от 13.08.2006 № 491 Об утверждении Правил содержания общего имущества в МКД"
     * "ПП 290" → "найди в Постановлении Правительства РФ от 03.04.2013 № 290 О минимальном перечне услуг"
     * "ПП 75" → "найди в Постановлении Правительства РФ от 06.02.2006 № 75 Об открытом конкурсе"
     * "ПП 124" → "найди в Постановлении Правительства РФ от 14.02.2012 № 124 О правилах обязательных"
     * "ПП 416" → "найди в Постановлении Правительства РФ от 15.05.2013 № 416 О порядке управления МКД"
     * "ПП 1110" → "найди в Постановлении Правительства РФ от 28.10.2014 № 1110 О лицензировании"
     * "ЖК РФ" → "найди в Жилищном кодексе Российской Федерации"
     * "ГК РФ" или "Гражданский кодекс" → "найди в Гражданском кодексе Российской Федерации"
     * "ФЗ 261" → "найди в Федеральном законе от 23.11.2009 № 261-ФЗ Об энергосбережении"
     * "ФЗ 152" → "найди в Федеральном законе от 27.07.2006 № 152-ФЗ О персональных данных"
     * "ФЗ 190" → "найди в Федеральном законе от 27.07.2010 № 190-ФЗ О теплоснабжении"
     * "Приказ 938" → "найди в Приказе Минстроя РФ от 25.12.2015 № 938 пр Об утверждении Порядка"
     * "Приказ 44" → "найди в Приказе Минстроя РФ от 28.01.2019 № 44 пр Об утверждении Требований"
   - ЕСЛИ упомянутo НЕСКОЛЬКО документов: перечисли ВСЕ через "или"

7. ИСКЛЮЧАЙ разъяснения и письма: если пользователь спрашивает "как рассчитывается по Правилам 354",
   НЕ добавляй в ответ ссылки на Письма Минстроя или другие разъяснительные документы.
   ИЩИ ТОЛЬКО в основном документе, который указан в запросе.

8. Ответ ТОЛЬКО переформулированным вопросом, без объяснений

ВОПРОС ПОЛЬЗОВАТЕЛЯ: {original_query}

УЛУЧШЕННЫЙ ВОПРОС:"""
```

### Параметры YandexGPT:
- **Модель:** `yandexgpt-lite`
- **Temperature:** 0.3
- **MaxTokens:** 100
- **Timeout:** 5.0 сек

### Пример работы:
- **Вход:** "как сменить УК"
- **Выход:** "расторжение или изменение договора управления многоквартирным домом"

---

## ПРОМПТ #2: Валидация результатов поиска

**Функция:** `validate_results_with_llm(query, results_with_scores, top_k)`
**Строка:** 249 (обновлено 2026-01-09)
**Назначение:** Проверка содержат ли найденные фрагменты КОНКРЕТНЫЙ ответ на вопрос

### Полный промпт:

```python
prompt = f"""Ты - эксперт по нормативным документам ЖКХ РФ.
Проанализируй вопрос пользователя и найденные фрагменты документов.

ВОПРОС ПОЛЬЗОВАТЕЛЯ: {query}

НАЙДЕННЫЕ ФРАГМЕНТЫ НОРМАТИВНЫХ ДОКУМЕНТОВ:{fragments_text}

ЗАДАЧА:
Определи, содержат ли эти фрагменты КОНКРЕТНЫЙ ответ на вопрос.

КРИТЕРИИ:
1. ✅ КОНКРЕТНЫЙ ОТВЕТ ЕСТЬ, если фрагмент содержит:
   - Четкое требование/обязанность/правило
   - Порядок действий/алгоритм
   - Конкретные сроки
   - Перечень документов/услуг
   - Определение понятия
   - Адресат действия (кто должен что сделать)

2. ❌ КОНКРЕТНОГО ОТВЕТА НЕТ, если фрагмент содержит:
   - Только упоминание ключевых слов без контекста
   - Косвенную информацию без конкретики
   - Другую тему (хотя бы похожие слова)
   - Общие фразы без практической пользы

ОТВЕТ:
Если конкретный ответ ЕСТЬ - напиши: "ДА: [краткое описание ответа в 1 предложение]"
Если конкретного ответа НЕТ - напиши: "НЕТ: [причина почему нет ответа в 1 предложении]"

Примеры:
- Вопрос: "Где взять справку о семье?"
  Фрагмент: "Граждане снимаются с учета в случае подачи заявления..."
  Ответ: НЕТ: фрагмент содержит процедуру снятия с учета, а не информацию о выдаче справок

- Вопрос: "Как часто проводить собрания?"
  Фрагмент: "Общие собрания проводятся не реже одного раза в год..."
  Ответ: ДА: установлена периодичность проведения общих собраний

Твой ответ:"""
```

### Параметры YandexGPT:
- **Модель:** `yandexgpt-lite`
- **Temperature:** 0.1 (низкая для детерминированности)
- **MaxTokens:** 50
- **Timeout:** 10.0 сек

### Логика обработки ответа (ИСПРАВЛЕНО 2026-01-09):
```python
if llm_answer.startswith("ДА:"):
    return True, llm_answer[4:].strip()
elif llm_answer.startswith("НЕТ:"):
    return False, llm_answer[5:].strip()
else:
    # ИСПРАВЛЕНО (2026-01-09): Если формат не понятен - считаем что ответа НЕТ (безопаснее)
    return False, f"Некорректный формат ответа LLM: {llm_answer}"
```

---

## ПРОМПТ #3: Реранжирование результатов

**Функция:** `rerank_results_with_llm(query, results_with_scores)`
**Строка:** 372 (обновлено 2026-01-09)
**Назначение:** Выбор лучшего фрагмента из найденных результатов

### Полный промпт:

```python
prompt = f"""Ты - эксперт по нормативным документам РФ.
Проанализируй, какой из предложенных фрагментов ЛУЧШЕ ВСЕГО отвечает на вопрос пользователя.

ВОПРОС ПОЛЬЗОВАТЕЛЯ:
{query}

НАЙДЕННЫЕ ФРАГМЕНТЫ:
{results_text}

КРИТЕРИИ ОЦЕНКИ:
1. Прямой ответ на вопрос (определение, перечень, порядок)
2. Полнота ответа (чем полнее, тем лучше)
3. Релевантность (не отвечает на соседний вопрос)
4. Официальный источник (статья закона лучше чем письмо)

УКАЖИ НОМЕР ЛУЧШЕГО ФРАГМЕНТА (цифрой от 1 до {len(results_with_scores)}):
"""
```

### Параметры YandexGPT:
- **Модель:** `yandexgpt-lite`
- **Temperature:** 0.3
- **MaxTokens:** 50
- **Timeout:** 5.0 сек

### Логика обработки ответа (ИСПРАВЛЕНО 2026-01-09):
```python
# ИСПРАВЛЕНО (2026-01-09): Убрано ограничение до 20, теперь поддерживаются любые числа
match = re.search(r'\b(\d+)\b', llm_answer)

if match:
    best_idx = int(match.group(1)) - 1  # Конвертируем в 0-based index
    best_idx = max(0, min(best_idx, len(results_with_scores) - 1))

    # Перемещаем лучший результат на первое место с высокой оценкой
    best_doc, best_score = results_with_scores.pop(best_idx)
    results_with_scores.insert(0, (best_doc, 0.99))
```

**Было (КРИТИЧЕСКАЯ ОШИБКА):**
```python
# Работало только для чисел 1-20
match = re.search(r'\b([1-9]|1[0-9]|20)\b', llm_answer)
```

---

## ПРОМПТ #4: Упрощение текста

**Функция:** `simplify_text_with_llm(text, max_length)`
**Строка:** 1115 (обновлено 2026-01-09)
**Назначение:** Упрощение канцелярского текста нормативных документов на простой язык

### Полный промпт:

```python
prompt = f"""Ты - эксперт по объяснению юридических текстов простым языком.

⚠️⚠️⚠️ СВЕРХКРИТИЧЕСКИ ВАЖНО: СОХРАНИТЬ ВСЕ ДАТЫ, ГОДЫ, СРОКИ ⚠️⚠️⚠️

ПРАВИЛА (выполняются ТОЧНО):
1. ВСЕ даты и сроки ДОЛЖНЫ остаться в ответе:
   - Все года: 2021, 2022, 2023, 2024, 2025, 2026, 2027, etc.
   - Все месяцы и дни
   - Все часы: "24 часа", "48 часов"
   - Все проценты: "7 процентов", "14 процентов", "20 процентов"
   - Все суммы: "3000 ₽", "10 копеек"

2. ЕСЛИ В ТЕКСТЕ ЕСТЬ ШТРАФНЫЕ САНКЦИИ (даты 2025-2027) - ОБЯЗАТЕЛЬНО включи их в раздел **Сроки**!

3. Указывай КТО за что отвечает

4. Структура ответа:
   **Главное:** [суть в 1-2 предложениях]
   **Сроки:** [перечисли ВСЕ даты, сроки, проценты]
   **Ответственность:** [кто за что отвечает]
   **Плюс:** [важные детали]

5. Используй простые слова

ПРИМЕР ПРАВИЛЬНОГО ОТВЕТА:
**Главное:** гарантирующий поставщик обязан установить приборы учета
**Сроки:**
- не позднее 6 месяцев
- до 31 декабря 2023 г.
- до 31 декабря 2021 г.
- штрафы: с 1 января 2025 г. - 7%, с 1 января 2026 г. - 14%, с 1 января 2027 г. - 20%
**Ответственность:** гарантирующий поставщик

Текст для упрощения:
{text_for_prompt}

Упрощенный текст:"""
```

### Параметры YandexGPT:
- **Модель:** `yandexgpt-lite`
- **Temperature:** 0.3 (понижена для стабильности)
- **MaxTokens:** 300 (настраивается через параметр `max_length`)
- **Timeout:** 10.0 сек
- **Лимит входного текста:** 3000 символов

### Структура ответа:
```
**Главное:** [суть в 1-2 предложениях]
**Сроки:** [ВСЕ даты, годы, проценты, штрафы]
**Ответственность:** [кто за что отвечает]
**Плюс:** [важные детали]
```

---

## API Endpoints

Приложение предоставляет следующие endpoints:

### 1. POST `/search` - Поиск по документам

**Запрос:**
```json
{
  "query": "как сменить УК",
  "top_k": 5
}
```

**Ответ:**
```json
{
  "results": [
    {
      "document": "Жилищный кодекс Российской Федерации",
      "article": "ст. 44",
      "content": "Общее собрание собственников...",
      "metadata": {...},
      "similarity": 0.95
    }
  ],
  "reformulated_query": "расторжение или изменение договора управления многоквартирным домом...",
  "original_query": "как сменить УК",
  "tokens_used": 100
}
```

### 2. POST `/simplify` - Упрощение текста

**Запрос:**
```json
{
  "text": "Граждане снимаются с учета в случае подачи заявления...",
  "max_length": 300
}
```

**Ответ:**
```json
{
  "original_text": "Граждане снимаются с учета...",
  "simplified_text": "**Главное:** ...",
  "tokens_used": 150
}
```

---

## Конфигурация

**Векторная БД:** `/home/olga/normativ_docs/Волков/vector-db-test/vectordb/`
**Модель эмбеддингов:** `intfloat/multilingual-e5-base`
**API YandexGPT:** https://llm.api.cloud.yandex.net/foundationModels/v1/completion

**Переменные окружения (из `.env`):**
- `YANDEX_API_KEY` - API ключ YandexGPT
- `YANDEX_FOLDER_ID` - ID папки Yandex Cloud

---

## Особенности промптов

### 1. КРИТИЧЕСКИЕ АКЦЕНТЫ:
- **Промпт #1:** Сохранение ВСЕХ дат и сроков в промпте #4
- **Промпт #1:** Приоритет конкретных документов (Правила 354, ЖК РФ и т.д.)
- **Промпт #1:** Исключение разъяснительных писем
- **Промпт #4:** СВЕРХКРИТИЧЕСКОЕ требование сохранять штрафные санкции (2025-2027)

### 2. Настройки temperature:
- **0.1** - для валидации (максимальная детерминированность)
- **0.3** - для переформулирования, реранжирования и упрощения (баланс креативности и точности)

### 3. Лимиты токенов:
- **100** - для переформулирования (короткий ответ)
- **50** - для валидации и реранжирования (только номер/да-нет)
- **300** - для упрощения (развернутый ответ, настраиваемый)

### 4. Timeout:
- **5.0 сек** - для быстрых операций (переформулирование, реранжинг)
- **10.0 сек** - для тяжелых (валидация с фрагментами, упрощение текста)

---

## История изменений

### 2026-01-09: Обновление номеров строк в документации
✅ **Обновление:** Актуализированы номера строк в соответствии с текущей версией кода
- reformulate_query: 103 (было 62)
- validate_results_with_llm: 249 (было 199)
- rerank_results_with_llm: 372 (было 316)
- simplify_text_with_llm: 1115 (было 767)

**Причина:** В код были добавлены новые функции и комментарии, что сместило номера строк

### 2026-01-09: Критические исправления
✅ **Исправление #1:** Убрано ограничение regex до 20 результатов в `rerank_results_with_llm()`
- Было: `r'\b([1-9]|1[0-9]|20)\b'` (только 1-20)
- Стало: `r'\b(\d+)\b'` (любые числа)

✅ **Исправление #2:** Усилена безопасность валидации в `validate_results_with_llm()`
- Было: `return True, "Не удалось определить"` (опасно)
- Стало: `return False, "Некорректный формат ответа LLM"` (безопасно)

### 2026-01-07: Предыдущие исправления
- Увеличен лимит текста до 3000 символов для упрощения
- Добавлен СВЕРХКРИТИЧЕСКИЙ акцент на сохранении дат
- Понижена temperature до 0.3 для стабильности
- Исправлена структура ответа Yandex API

---

## Схема работы приложения

```
1. Пользователь: "как сменить УК"
   ↓
2. Промпт #1 (переформулирование)
   → "расторжение договора управления многоквартирным домом"
   ↓
3. Векторный поиск: находит 5 фрагментов
   ↓
4. Промпт #2 (валидация)
   → "ДА: найдена процедура расторжения"
   ↓
5. Промпт #3 (реранжинг)
   → Выбирает фрагмент #2 как наиболее релевантный
   ↓
6. Промпт #4 (упрощение)
   → Переводит на простой язык с сохранением сроков
   ↓
7. Пользователь получает: простой и понятный ответ
```

---

## Техническая информация

**Основной файл:** `/home/olga/normativ_docs/Волков/vector-db-test/backend/main_cpu.py`
**Дата создания инструкции:** 2026-01-09
**Версия:** 1.0

Приложение разработано для работы с нормативными документами ЖКХ РФ.
