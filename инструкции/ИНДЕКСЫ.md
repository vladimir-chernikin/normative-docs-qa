# ВЕКТОРНЫЕ ИНДЕКСЫ НОРМАТИВНЫХ ДОКУМЕНТОВ

**Дата:** 2025-01-07
**Директория:** `/home/olga/normativ_docs/Волков/vector-db-test/vectordb/`

---

## ОБЗОР

**Что такое векторные индексы:**
- FAISS индексы для семантического поиска по нормативным документам
- Создаются на основе чанков (фрагментов документов)
- Используют модель embeddings: `intfloat/multilingual-e5-base`
- Размерность векторов: 768

**Где лежат:**
```
/home/olga/normativ_docs/Волков/vector-db-test/vectordb/
```

**Сколько индексов:**
- **18 отдельных баз** - по одной на каждый документ
- Каждая база оптимизирована для конкретного документа

---

## СПИСОК ВСЕХ 18 ИНДЕКСОВ

### КОДЕКСЫ (3 индекса)

1. **Гражданский_кодекс_Российской_Федерации_часть_первая**
   - Документ: ГК РФ (часть первая)
   - Тип: CODE
   - Охват: общие положения, право собственности, обязательства

2. **Гражданский_кодекс_Российской_Федерации_часть_вторая**
   - Документ: ГК РФ (часть вторая)
   - Тип: CODE
   - Охват: договоры, обязательственные право

3. **Жилищный_кодекс_Российской_Федерации**
   - Документ: ЖК РФ
   - Тип: CODE
   - Охват: права собственников, управление МКД, коммунальные услуги

---

### ПОСТАНОВЛЕНИЯ ПРАВИТЕЛЬСТВА РФ (7 индексов)

4. **ПП_РФ_от_06.05.2011_№_354_Правила_предоставления_коммунальных_услуг_Правила_№_354**
   - Документ: Постановление № 354 (Правила 354)
   - Тип: GOVERNMENT_DECREE
   - Охват: предоставление коммунальных услуг, расчет платы, качество услуг
   - **Чанков:** 692 (после улучшения)
   - **Статус:** ✓ ХОРОШО (53.2% оптимальных чанков)

5. **ПП_РФ_от_03.04.2013_№_290_О_минимальном_перечне_услуг_и_работ_по_содержанию_общего_имущества_в_МКД**
   - Документ: Постановление № 290
   - Тип: GOVERNMENT_DECREE
   - Охват: минимальный перечень услуг и работ

6. **ПП_РФ_от_06.02.2006_№_75_Об_открытом_конкурсе_по_отбору_управляющей_организации_МКД**
   - Документ: Постановление № 75
   - Тип: GOVERNMENT_DECREE
   - Охват: конкурс по отбору управляющей компании

7. **ПП_РФ_от_13.08.2006_№_491-Об_утверждении_Правил_содержания_общего_имущества_в_МКД**
   - Документ: Постановление № 491 (Правила 491)
   - Тип: GOVERNMENT_DECREE
   - Охват: содержание общего имущества

8. **ПП_РФ_от_14.02.2012_№_124-О_правилах_обязательных_при_заключении_договоров_снабжения_коммунальными_ресурсами**
   - Документ: Постановление № 124
   - Тип: GOVERNMENT_DECREE
   - Охват: договоры снабжения коммунальными ресурсами

9. **ПП_РФ_от_15.05.2013_№_416-О_порядке_осуществления_деятельности_по_управлению_многоквартирными_домами**
   - Документ: Постановление № 416
   - Тип: GOVERNMENT_DECREE
   - Охват: деятельность по управлению МКД

10. **ПП_РФ_от_23.05.2006_№_306_Правила_установления_нормативов_потребления_коммунальных_услуг_Правила_№_306**
    - Документ: Постановление № 306 (Правила 306)
    - Тип: GOVERNMENT_DECREE
    - Охват: нормативы потребления коммунальных услуг

11. **ПП_РФ_от_28.10.2014_№_1110-О_лицензировании_предпринимательской_деятельности_по_управлению_МКД**
    - Документ: Постановление № 1110
    - Тип: GOVERNMENT_DECREE
    - Охват: лицензирование управляющих организаций

---

### ПРИКАЗЫ МИНСТРОЯ РФ (2 индекса)

12. **Приказ_Минстроя_РФ_от_25.12.2015_№_938_пр-Об_утверждении_Порядка_внесения_изменений_в_реестр_лицензий**
    - Документ: Приказ № 938 пр
    - Тип: MINISTRY_ORDER
    - Охват: реестр лицензий УК

13. **Приказ_Минстроя_РФ_от_28.01.2019_№_44_пр-Об_утверждении_Требований_к_оформлению_протоколов_общих_собраний_собственников_помещений_в_МКД**
    - Документ: Приказ № 44 пр
    - Тип: MINISTRY_ORDER
    - Охват: оформление протоколов общих собраний

---

### ПИСЬМА МИНСТРОЯ РФ (2 индекса)

14. **Письмо_Минстроя_РФ_от_04.04.2016_№_9667-ОД-04_о_порядке_оформления_актов_приемки_работ_по_договору_управления_МКД**
    - Документ: Письмо № 9667-ОД-04
    - Тип: LETTER
    - Охват: акты приемки работ

15. **Письмо_Минстроя_РФ_от_17.11.2017_№_50534-ОГ-04_о_порядке_перерасчета_коммунальных_ресурсов_на_общедомовые_нужды**
    - Документ: Письмо № 50534-ОГ-04
    - Тип: LETTER
    - Охват: перерасчет коммунальных ресурсов

---

### ФЕДЕРАЛЬНЫЕ ЗАКОНЫ (3 индекса)

16. **Федеральный_закон_от_23.11.2009_№_261-ФЗ-Об_энергосбережении_и_о_повышении_энергетической_эффективности**
    - Документ: ФЗ № 261
    - Тип: CODE (федеральные законы обрабатываются как кодексы)
    - Охват: энергосбережение, энергоэффективность

17. **Федеральный_закон_от_27.07.2006_№_152-ФЗ-О_персональных_данных**
    - Документ: ФЗ № 152
    - Тип: CODE
    - Охват: персональные данные, защита информации

18. **Федеральный_закон_от_27.07.2010_№_190-ФЗ-О_теплоснабжении**
    - Документ: ФЗ № 190
    - Тип: CODE
    - Охват: теплоснабжение

---

## СТРУКТУРА ИНДЕКСА

Каждая база содержит:

```
vector-db-test/vectordb/Имя_Документа/
├── index.faiss          # FAISS индекс (векторы)
└── index.pkl           # Docstore (метаданные и тексты)
```

**index.faiss:**
- Векторы embeddings (768 измерений)
- Структура для быстрого поиска (ANN - Approximate Nearest Neighbors)

**index.pkl:**
- Тексты чанков
- Метаданные (документ, тип, раздел, статья, пункт)
- Соответствие векторов и текстов

---

## ПРОВЕРКА РАБОТЫ ИНДЕКСА

### Способ 1: Через Python

```bash
cd /home/olga/normativ_docs/Волков
python3 << 'EOF'
import sys
from pathlib import Path
from sentence_transformers import SentenceTransformer
from langchain_community.vectorstores import FAISS
from utils.embeddings import SentenceTransformerEmbeddings

model = SentenceTransformer('intfloat/multilingual-e5-base')
embeddings = SentenceTransformerEmbeddings(model)

db_path = Path("vector-db-test/vectordb/ПП_РФ_от_06.05.2011_№_354_Правила_предоставления_коммунальных_услуг_Правила_№_354")
vectorstore = FAISS.load_local(str(db_path), embeddings, allow_dangerous_deserialization=True)

print(f"Векторов: {vectorstore.index.ntotal:,}")
print(f"Документов: {len(vectorstore.docstore._dict):,}")

# Тестовый поиск
results = vectorstore.similarity_search("коммунальные услуги", k=3)
for i, doc in enumerate(results, 1):
    print(f"\nРезультат #{i}:")
    print(f"Текст: {doc.page_content[:200]}...")
    print(f"Метаданные: {doc.metadata}")
EOF
```

### Способ 2: Через бэкенд API

**Запустить бэкенд:**
```bash
python vector-db-test/backend/main_cpu.py
```

**Сделать запрос:**
```bash
curl -X POST http://localhost:8001/llm-search \
  -H "Content-Type: application/json" \
  -d '{"query": "коммунальные услуги", "database": "current"}'
```

### Способ 3: Через фронтенд

1. Запустить бэкенд: `python vector-db-test/backend/main_cpu.py`
2. Запустить фронтенд: `python run_frontend_server.py`
3. Открыть: http://localhost:8080
4. Ввести запрос: "коммунальные услуги"
5. Проверить что находятся релевантные фрагменты

---

## ДИАГНОСТИКА ПРОБЛЕМ

### Проблема 1: Индекс не загружается

**Симптомы:**
```
FileNotFoundError: [Errno 2] No such file or directory: 'index.faiss'
```

**Решение:**
1. Проверить что база существует: `ls vector-db-test/vectordb/`
2. Проверить наличие файлов: `ls vector-db-test/vectordb/Имя_Базы/`
3. Если файлов нет - создать базу заново (см. "Как пересоздать базу")

---

### Проблема 2: Ошибка размерности

**Симптомы:**
```
ValueError: Index dimension mismatch (expected 768, got X)
```

**Решение:**
1. Проверить какая модель используется в `config.py`
2. Удалить старую базу: `rm -rf vector-db-test/vectordb/Имя_Базы/`
3. Пересоздать базу с правильной моделью

---

### Проблема 3: Плохие результаты поиска

**Симптомы:**
- Поиск находит нерелевантные фрагменты
- Нет ожидаемых документов в топе результатов

**Диагностика:**

1. **Проверить качество чанков:**
   ```bash
   python check_chunk_quality.py reports/test_chunks_government_decree.json "ПП РФ № 354"
   ```

2. **Проверить статистику базы:**
   - Сколько чанков (оптимально: 300-1500)
   - Средний размер чанка (оптимально: 300-800 символов)
   - Процент огромных чанков > 2000 символов (должен быть < 5%)

3. **Если качество плохое** - пересоздать базу с улучшенным чанкером

---

### Проблема 4: Нет памяти при загрузке

**Симптомы:**
```
MemoryError: Unable to allocate array
```

**Решение:**
1. Загружать базы по одной (а не все сразу)
2. Использовать меньшую модель (e5-small вместо e5-base)
3. Увеличить swap: `sudo fallocate -l 4G /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile`

---

## ПЕРЕСОЗДАНИЕ БАЗЫ

### Когда нужно пересоздавать базу:

- ✅ Улучшен алгоритм чанков (как было с ПП РФ № 354)
- ✅ Плохое качество поиска (слишком крупные чанки)
- ✅ Обновлен документ (новая версия)
- ✅ Ошибка в структуре документа

### Как пересоздать базу:

**Шаг 1: Удалить старую базу**
```bash
cd /home/olga/normativ_docs/Волков
rm -rf vector-db-test/vectordb/Имя_Документа/
```

**Шаг 2: Создать новую базу**
```bash
python document_processor.py "Название_документа.docx"
```

**Шаг 3: Проверить качество**
```bash
python universal_chunker.py "Название_документа.docx"
python check_chunk_quality.py reports/test_chunks_<тип>.json "Имя документа"
```

**Пример для ПП РФ № 354:**
```bash
rm -rf vector-db-test/vectordb/ПП_РФ_от_06.05.2011_№_354_Правила_предоставления_коммунальных_услуг_Правила_№_354/
python document_processor.py "ПП РФ от 06.05.2011 № 354 Правила предоставления коммунальных услуг (Правила № 354).docx"
```

---

## СТАТИСТИКА ПО ВСЕМ БАЗАМ

**Общая информация:**
- Всего баз: 18
- Модель embeddings: `intfloat/multilingual-e5-base`
- Размерность векторов: 768
- Общий размер: ~500 MB (зависит от количества чанков)

**Распределение по типам:**
- Кодексы и ФЗ: 3 баз
- Постановления Правительства: 7 баз
- Приказы: 2 базы
- Письма: 2 базы
- Федеральные законы: 3 базы

**Качество чанков (на примере ПП РФ № 354):**
- Чанков: 692
- Средний размер: 832 символа
- Оптимальных чанков: 53.2%
- Огромных чанков (>2000): 0.6%

---

## РЕКОМЕНДАЦИИ

### Для эксплуатации:

1. **Не удаляйте индексы** - они используются для поиска
2. **Делайте бэкапы** перед обновлением базы
3. **Проверяйте качество** после создания новой базы
4. **Используйте отдельные базы** для каждого документа (не объединяйте)

### Для разработки:

1. **Тестируйте чанки** перед созданием базы
2. **Используйте модель e5-base** для лучшего качества
3. **Оптимальный размер чанка:** 300-800 символов
4. **Ограничение для постановлений:** MAX 1000 символов

### Для мониторинга:

1. **Регулярно проверяйте** работу поиска через фронтенд
2. **Собирайте обратную связь** от пользователей о качестве поиска
3. **Обновляйте базы** при изменении документов
4. **Храните бэкапы** стабильных версий

---

## КОНТАКТЫ

**Проект:** QA система для нормативных документов ЖКХ
**Директория:** `/home/olga/normativ_docs/Волков/`
**Дата:** 2025-01-07
