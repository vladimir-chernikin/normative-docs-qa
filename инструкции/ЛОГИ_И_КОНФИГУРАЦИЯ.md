# ЛОГИ И КОНФИГУРАЦИЯ

**Дата:** 2025-01-07
**Директория:** `/home/olga/normativ_docs/Волков/`

---

## КОНФИГУРАЦИОННЫЕ ФАЙЛЫ

### Структура конфигов (стандартная для Python проектов)

```
/home/olga/normativ_docs/Волков/
├── config.py              # Питоновская конфигурация (пути, настройки)
├── .env                   # Секреты (API ключи, пароли)
└── .env.example           # Пример .env для разработчиков
```

**Всего: 3 конфига** (правильная практика для Python проектов)

---

### 1. config.py - Главный конфигурационный файл

**Файл:** `config.py`
**Тип:** Python модуль
**Назначение:** Централизованная конфигурация для всех скриптов

#### Содержимое:

```python
# Базовая директория проекта
BASE_DIR = Path(__file__).parent

# Директории
FULLDOCS_DIR = BASE_DIR / "fulldocx"          # Исходные документы
VECTORDB_DIR = BASE_DIR / "vector-db-test" / "vectordb"  # Векторные базы
REPORTS_DIR = BASE_DIR / "reports"            # Отчеты (JSON)
LOGS_DIR = BASE_DIR / "logs"                  # Логи

# Модель для эмбедингов
EMBEDDING_MODEL = "intfloat/multilingual-e5-base"

# Настройки обработки
CHUNK_SIZE = 2000
CHUNK_OVERLAP = 200
MIN_CHUNK_SIZE = 100

# Параметры векторного поиска
SEARCH_K = 50

# Параметры валидации
MIN_CHUNKS_COUNT = 2
MIN_AVG_CHUNK_SIZE = 100

# Логирование
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()
LOG_FILE = LOGS_DIR / "processing.log"
LOG_FORMAT = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
```

#### Использование:

```python
from config import BASE_DIR, EMBEDDING_MODEL, LOG_FILE
```

---

### 2. .env - Секретные данные

**Файл:** `.env`
**Тип:** Файл переменных окружения
**Назначение:** Хранение секретов (API ключи, токены)
**Важно:** `.env` добавлен в `.gitignore` (не попадает в Git)

#### Содержимое:

```bash
# YandexGPT API (используется для переформулирования запросов и генерации ответов)
YANDEX_API_KEY=YOUR_YANDEX_API_KEY
YANDEX_FOLDER_ID=YOUR_YANDEX_FOLDER_ID

# Аутентификация API (опционально)
API_AUTH_ENABLED=false
API_KEY=qa-system-2025-change-this-key-in-production

# Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO
```

#### Использование в коде:

```python
import os
from dotenv import load_dotenv

# Загрузка .env
load_dotenv()

# Чтение переменных
api_key = os.getenv("YANDEX_API_KEY")
folder_id = os.getenv("YANDEX_FOLDER_ID")
log_level = os.getenv("LOG_LEVEL", "INFO")
```

---

### 3. .env.example - Пример конфигурации

**Файл:** `.env.example`
**Тип:** Пример переменных окружения
**Назначение:** Шаблон для разработчиков (без секретов)

#### Содержимое:

```bash
# QA Система для Нормативных Документов ЖКХ
# Пример переменных окружения
# Скопируйте этот файл в .env и настройте значения

# YandexGPT API (используется для переформулирования запросов и генерации ответов)
YANDEX_API_KEY=your_yandex_api_key_here
YANDEX_FOLDER_ID=your_yandex_folder_id_here

# Аутентификация API (опционально)
API_AUTH_ENABLED=false
API_KEY=change-this-key-in-production

# Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO
```

#### Использование:

Для нового разработчика:
```bash
# Скопировать пример
cp .env.example .env

# Редактировать .env и добавить свои ключи
nano .env
```

---

## ЛОГИ

### Структура папок для логов

```
/home/olga/normativ_docs/Волков/
├── logs/                          # Общие логи всех скриптов
│   └── processing.log             # Лог обработки документов
└── vector-db-test/
    └── logs/                      # Логи бэкенда (пустая, готова к использованию)
```

---

### 1. processing.log - Лог обработки документов

**Файл:** `logs/processing.log`
**Размер:** ~239 KB (может расти)
**Период:** С 6 января 2025 по настоящее время
**Назначение:** Логирование работы скриптов обработки документов

#### Что записывается:

- Запуск `universal_chunker.py` - разбиение документов на чанки
- Запуск `document_processor.py` - создание векторных баз
- Загрузка модели `intfloat/multilingual-e5-base`
- Создание FAISS индексов
- Валидация чанков
- Тестовый поиск

#### Пример содержимого:

```
2026-01-07 11:35:37 - universal_chunker - INFO - Разбиваем большой чанк (3874 символов) на части
2026-01-07 11:35:37 - __main__ - INFO - Создано 692 чанков
2026-01-07 11:35:37 - __main__ - INFO - Валидация OK (средний размер: 832 символов)
2026-01-07 11:39:57 - __main__ - INFO - Векторная БД сохранена
2026-01-07 11:39:57 - __main__ - INFO - ПП РФ от 06.05.2011 № 354 - УСПЕХ!
```

#### Настройка логирования в config.py:

```python
LOG_FILE = LOGS_DIR / "processing.log"

def setup_logging():
    """Настройка логирования для всего приложения"""
    file_handler = logging.FileHandler(LOG_FILE, encoding='utf-8')
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(logging.Formatter(LOG_FORMAT, LOG_DATE_FORMAT))
```

#### Использование в скриптах:

```python
from config import setup_logging
import logging

# Настроить логирование
setup_logging()
logger = logging.getLogger(__name__)

# Записывать в лог
logger.info("Обработка документа началась")
logger.debug(f"Создано {len(chunks)} чанков")
logger.error("Ошибка при создании embeddings")
```

---

### 2. Логи бэкенда (будут добавлены)

**Папка:** `vector-db-test/logs/`
**Статус:** Пустая, готова к использованию
**Назначение:** Логи работы FastAPI бэкенда

#### Планируемые логи:

- `backend.log` - основной лог бэкенда
- `error.log` - лог ошибок
- `access.log` - лог запросов к API

#### Настройка в бэкенде:

**Файл:** `vector-db-test/backend/main_cpu.py`

```python
import logging

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Использование
@app.on_event("startup")
async def startup_event():
    logger.info("Бэкенд API сервер запущен")

@app.post("/llm-search")
async def llm_search(request: Request):
    logger.info(f"Поисковый запрос: {request.query}")
```

---

## .gitignore - Защита секретов и логов

**Файл:** `.gitignore`
**Назначение:** Исключение файлов из Git (секреты, логи, временные файлы)

### Правила для логов и конфигов:

```gitignore
# Environment
.env
.env.local

# Logs
*.log
logs/*.log

# Test reports (JSON files)
reports/*.json

# Secret files (API keys, credentials)
vector-db-test/august-bond-*.json
```

### Пояснение:

- `.env` - секреты не попадут в Git
- `*.log` - все лог-файлы исключены
- `logs/*.log` - явное указание для папки logs/
- `reports/*.json` - тестовые отчеты не попадут в Git

---

## ПРАВИЛА РАБОТЫ С КОНФИГАМИ И ЛОГАМИ

### Для разработчиков:

1. **Никогда не коммитить .env в Git** - используйте .env.example
2. **Все секреты в .env** - API ключи, пароли, токены
3. **Настройки в config.py** - пути, константы, параметры
4. **Логи пишутся в logs/** - не смешивать с отчетами

### Для эксплуатации:

1. **Проверять логи при ошибках:**
   ```bash
   tail -f logs/processing.log
   ```

2. **Очищать логи при необходимости:**
   ```bash
   # Архивировать старый лог
   mv logs/processing.log logs/processing_$(date +%Y%m%d).log

   # Создать новый пустой лог
   touch logs/processing.log
   ```

3. **Менять уровень логирования:**
   ```bash
   # В .env
   LOG_LEVEL=DEBUG   # Много информации
   LOG_LEVEL=INFO    # Обычный уровень
   LOG_LEVEL=ERROR   # Только ошибки
   ```

### Для мониторинга:

1. **Проверять размер логов:**
   ```bash
   du -sh logs/*.log
   ```

2. **Настроить rotatable логи (logrotate):**
   ```bash
   # /etc/logrotate.d/qa-system
   /home/olga/normativ_docs/Волков/logs/*.log {
       daily
       rotate 7
       compress
       missingok
       notifempty
   }
   ```

---

## ДИАГНОСТИКА ПРОБЛЕМ

### Проблема 1: Логи не пишутся

**Симптомы:** Файл `logs/processing.log` пустой или не создается

**Решение:**
1. Проверить права на папку: `ls -la logs/`
2. Проверить что LOG_FILE в config.py правильный
3. Проверить уровень логирования: `LOG_LEVEL=DEBUG`
4. Проверить что вызывается `setup_logging()` в скрипте

### Проблема 2: Бэкенд не видит API ключи

**Симптомы:** Ошибка `YANDEX_API_KEY is not set`

**Решение:**
1. Проверить что .env существует в корне: `ls -la .env`
2. Проверить содержимое .env: `cat .env`
3. Проверить что бэкенд загружает .env: `load_dotenv(project_root.parent / ".env")`
4. Перезапустить бэкенд

### Проблема 3: Config не обновляется

**Симптомы:** Изменения в config.py не применяются

**Решение:**
1. Удалить скомпилированный .pyc: `find . -name "*.pyc" -delete`
2. Перезапустить скрипт
3. Проверить что импортируете правильный config

---

## КОНТАКТЫ

**Проект:** QA система для нормативных документов ЖКХ
**Директория:** `/home/olga/normativ_docs/Волков/`
**Дата:** 2025-01-07
